import { AsideText } from "../components/Aside.tsx";
import { BashSnippetToCopy } from "../components/BashSnippetToCopy";
import { Hovernote } from "../components/Hovernote.tsx";
import { Garnix, Garn } from "../components/Typography";

export const info = {
  name: "getting started",
  url: "getting_started",
  index: 1,
};

# Getting Started

## Installation

The easiest way to install <Garn/> is with the following command:

<BashSnippetToCopy snippet="sh <(curl --proto '=https' --tlsv1.2 -sSf https://garn.io/install.sh)" />

You can look at the contents of the script [here](https://garn.io/install.sh).

<Garn /> requires [Nix](https://nixos.org/). If you don't have Nix, the above
command will install it for you.

### Manual installation

If you prefer, you can also manually do the steps that the above script automates. Those are:

1. **Install Nix**. To install Nix, follow the instructions [here](https://nixos.org/download).
2. **Configure Nix to use the <Garnix/> cache**. You can do that by adding the lines:

```
extra-substituters = https://cache.garnix.io
extra-trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
```

To `/etc/nix/nix.conf` (note that you'll need sudo).

3. **Restart the Nix daemon**. (Only necessary for multi-user installations, which are the default.) On Linux, that is:

```
sudo systemctl restart nix-daemon.service
```

And on Macs, it is:
```
sudo launchctl kickstart -k system/org.nixos.nix-daemon
```
(You can run `nix-shell -p nix-info --run "nix-info -m"` to double-check whether you have a multi-user installation.)

4. **Install <Garn/>**. You can do that with:

```
nix --extra-experimental-features 'nix-command flakes' profile install -L github:garnix-io/garn
```


5. **Check that everything worked**. Run `garn --help` to confirm that <Garn/> is installed.

## Your first `garn.ts` config

All examples in this getting started guide are also available
[here](https://github.com/garnix-io/garn/tree/main/examples/getting-started).

<Garn /> projects are configured with a single `garn.ts` file. (This file is read by <Garn /> rather than run directly via `node` or `deno`.) Your `garn.ts`
exports a collection of `Project`s. A `Project` contains all the information
needed to build, run, and develop your software.

The <Garn/> library exports a lot of helpers that make it easy to quickly
construct projects for common stacks, but you can also define these yourself.

Here is an example `garn.ts` file for a single node-based project:

```typescript
import * as garn from "https://garn.io/ts/v0.0.12/mod.ts";
import * as pkgs from "https://garn.io/ts/v0.0.12/nixpkgs.ts";

export const frontend = garn.javascript.mkNpmProject({
  description: "my frontend",
  nodeVersion: "18",
  src: "./frontend",
});
```

In the same directory you can now run `garn enter frontend` to enter a shell
with `node` version 18 available.

<AsideText type="hint">You may have noticed that running `garn enter frontend` generated two files, `flake.nix` and `flake.lock`. These should be committed to your repository rather than gitignored. They both ensure reproducibility, and allow Nix to be used directly rather than only via <Garn/>. </AsideText>

Note that if you do this in a git repo <Garn/> requires that your source
files be tracked by git. You have to add them to your index, or at least
mark them as intended additions with `git add --intent-to-add`.<Hovernote>This is a somewhat obnoxious requirement of Nix, intended to ensure that you don't accidentally end up getting different behavior than others will, due to uncommited or ignored files. Likely this requirement will be removed from future <Garn/> versions.</Hovernote>

```bash
> git add --intent-to-add frontend
> garn enter frontend
[garn] Entering frontend shell. Type 'exit' to exit.
[...]
> node --version
v18.17.1
```

`Projects` can contain `Check`s, which can be used to run automated tests for
your project. You can add them with `addCheck`.

```typescript
export const frontend = garn.javascript
  .mkNpmProject({
    description: "my frontend",
    nodeVersion: "18",
    src: "./frontend",
  })
  .addCheck("test")`npm test`;
```

Now running `garn check frontend` will run `npm test` in the frontend project
environment. These `Check`s are pure, i.e. they are run in a build sandbox. The
downside of sandboxing is that these checks won't have access to the internet.
The upside is that they'll be (almost) perfectly reproducible, cacheable, and runnable on CI.



## Multi-language support

You can configure multiple sub-projects with different tech stacks in a single
`garn.ts` file. Let's try to add a go backend:

```typescript
export const backend = garn.go.mkGoProject({
  description: "my backend",
  src: "./backend",
  goVersion: "1.20",
});
```

This means that you can use <Garn/> to configure bigger multi-language projects.
This enables anyone to run, test, and develop any part of your codebase,
without having to install any language-specific tools or learn how to use them.

## Deno LSP

`garn.ts` files are powered by [deno](https://deno.com/). A lot of the
convenience and power for editing your `garn.ts` files comes from having a
working Deno LSP. There are two ways of setting up LSP for editing `garn.ts`
files: using <Garn/> itself to provide a properly-configured editor with
`editGarnConfig`, or setting up your editor yourself.

### `editGarnConfig`

<Garn /> offers an `Executable` called `editGarnConfig`. It will spin up a
vscodium editor that is pre-configured for editing `garn.ts` files. It won't use
or modify your local vscodium settings, if you have any. You can can add it to
your `garn.ts` file like this:

```typescript
export const edit = garn.editGarnConfig;
```

And then run it with `garn run edit`.

This is a very easy way to get up and running with editing `garn.ts` files. The
disadvantage is that the editor isn't your normal configured editor. So you
might consider installing the Deno LSP and configuring your editor:

### Installing the Deno LSP and configuring your editor

Alternatively you an install `deno` (including the Deno LSP) with <Garn/> itself:

```typescript
export const deno = garn.mkProject(
  {
    description: "garn configuration environment",
    defaultEnvironment: garn.emptyEnvironment.withDevTools([pkgs.deno]),
  },
  {}
);
```

`garn enter deno` will then drop you in a shell where `deno` is available.

For configuring your editor to use Deno's LSP refer to [Deno's environment setup
documentation](https://docs.deno.com/runtime/manual/getting_started/setup_your_environment).

## CI

Since the checks of your <Garn/> projects are sandboxed, it's easy to run them on
[garnix.io CI](https://garnix.io). See [the docs](https://garnix.io/docs)
for more info.

## Further reading

- [garn concepts](/docs/concepts)
- [typescript api](https://doc.deno.land/https://garn.io/ts/v0.0.12/mod.ts)
